<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oliver Kell Strategy Analyzer (Ultimate Pro)</title>
    <style>
        /* =========================================
           1. é«˜çº§è§†è§‰ç³»ç»Ÿ (UI System)
           ========================================= */
        :root {
            --primary-blue: #3182ce;
            --primary-dark: #2c5282;
            --accent-yellow: #d69e2e;
            --accent-purple: #805ad5;
            --danger-red: #e53e3e;
            --success-green: #38a169;
            --bg-color: #f7f9fc;
            --card-bg: #ffffff;
            --text-main: #2d3748;
            --text-sub: #718096;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.08);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 40px 20px;
            line-height: 1.6;
        }

        .container { max-width: 950px; margin: 0 auto; }

        /* ä¸»å¡ç‰‡å®¹å™¨ */
        .main-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 40px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 30px;
            border: 1px solid #e2e8f0;
        }

        h1 {
            margin-top: 0;
            color: var(--text-main);
            font-size: 28px;
            letter-spacing: -0.5px;
            border-bottom: 2px solid #edf2f7;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        /* è­¦å‘Šæ¨ªå¹… */
        .alert-banner {
            background-color: #fffaf0;
            border-left: 5px solid var(--accent-yellow);
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 30px;
            color: #744210;
            font-size: 14px;
        }

        /* è¾“å…¥åŒºåŸŸ */
        .input-section { display: flex; gap: 15px; margin-bottom: 10px; }
        input[type="text"] {
            flex: 1; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px;
            font-size: 18px; outline: none; transition: all 0.2s;
        }
        input[type="text"]:focus { border-color: var(--primary-blue); box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1); }
        
        .analyze-btn {
            padding: 0 35px; background-color: var(--primary-blue); color: white;
            border: none; border-radius: 10px; font-size: 16px; font-weight: 700;
            cursor: pointer; transition: transform 0.1s, background-color 0.2s;
        }
        .analyze-btn:hover { background-color: var(--primary-dark); transform: translateY(-1px); }
        .analyze-btn:disabled { background-color: #cbd5e0; cursor: not-allowed; transform: none; }

        #error-message {
            color: var(--danger-red); background: #fff5f5; border: 1px solid #fed7d7;
            padding: 12px; border-radius: 8px; margin-top: 15px; display: none; font-size: 14px;
        }

        /* =========================================
           2. æ ¸å¿ƒå‘¨æœŸç½‘æ ¼ (Cycle Grid)
           ========================================= */
        .cycle-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; margin-top: 30px;
        }

        .cycle-box {
            background: #edf2f7; border-radius: 12px; padding: 20px;
            border: 2px solid transparent; opacity: 0.5; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative; min-height: 200px; display: flex; flex-direction: column;
        }

        /* æ¿€æ´»çŠ¶æ€æ ·å¼ */
        .cycle-box.active {
            opacity: 1; background-color: #fff; border-color: var(--primary-blue);
            box-shadow: var(--shadow-md); transform: translateY(-5px); z-index: 10;
        }
        .cycle-box.bearish.active { border-color: var(--danger-red); background-color: #fff; }

        .cycle-box h3 { margin: 0 0 10px 0; font-size: 16px; color: var(--text-main); font-weight: 800; }
        .status-desc { font-size: 13px; color: var(--text-sub); margin-bottom: auto; line-height: 1.5; }
        .book-ref { font-size: 11px; color: #a0aec0; font-style: italic; margin-top: 15px; border-top: 1px solid #e2e8f0; padding-top: 8px; }
        
        .show-detail-btn {
            background: none; border: none; color: var(--primary-blue); font-size: 12px;
            font-weight: bold; cursor: pointer; margin-top: 10px; text-align: left; padding: 0; text-decoration: underline;
        }

        /* =========================================
           3. è¯¦æƒ…å¡ç‰‡ä¸å¼•ç”¨ (Deep Dive)
           ========================================= */
        .detail-section { grid-column: 1 / -1; display: none; animation: slideDown 0.4s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .detail-card-inner {
            background: #fff; border: 1px solid #e2e8f0; border-left: 5px solid var(--primary-blue);
            border-radius: 8px; padding: 25px; margin-bottom: 20px; box-shadow: var(--shadow-sm);
        }

        .strategy-list { list-style: none; padding: 0; margin: 0; }
        .strategy-item { padding-bottom: 20px; margin-bottom: 20px; border-bottom: 1px dashed #e2e8f0; }
        .strategy-item:last-child { border-bottom: none; padding-bottom: 0; margin-bottom: 0; }

        .item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .item-title { font-weight: 700; font-size: 15px; color: var(--text-main); }
        .item-desc { font-size: 13px; color: #4a5568; margin-bottom: 5px; }

        /* å¾½ç« ç³»ç»Ÿ */
        .badge { font-size: 10px; text-transform: uppercase; padding: 3px 8px; border-radius: 4px; font-weight: 800; letter-spacing: 0.5px; }
        .badge-stop { background-color: #fff5f5; color: var(--danger-red); border: 1px solid #fed7d7; }
        .badge-action { background-color: #f0fff4; color: var(--success-green); border: 1px solid #c6f6d5; }
        .badge-manual { background-color: #fffaf0; color: #b7791f; border: 1px solid #fbd38d; }

        /* ä¹¦æœ¬å¼•ç”¨æ¡† */
        .book-quote-box {
            background-color: #f7fafc; padding: 10px 15px; border-radius: 6px;
            font-size: 12px; color: #718096; font-style: italic; margin-top: 8px;
            border-left: 3px solid #cbd5e0;
        }

        /* =========================================
           4. æ•°æ®ä»ªè¡¨ç›˜ (Metrics)
           ========================================= */
        .metrics-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 20px; margin-top: 40px; padding-top: 30px; border-top: 2px dashed #e2e8f0;
        }
        .metric-card {
            background: #f8fafc; padding: 20px; border-radius: 12px; text-align: center;
            border: 1px solid #e2e8f0; box-shadow: var(--shadow-sm);
        }
        .metric-title { font-size: 11px; text-transform: uppercase; color: #a0aec0; letter-spacing: 1px; font-weight: 700; margin-bottom: 8px; }
        .metric-value { font-size: 24px; font-weight: 800; color: var(--text-main); font-family: "SF Mono", "Menlo", monospace; }

        /* ç‰¹æ®Šé¢œè‰² */
        .val-ema10 { color: var(--accent-yellow); }
        .val-ema20 { color: var(--accent-purple); }

        @media (max-width: 768px) {
            .cycle-grid { grid-template-columns: 1fr 1fr; }
            .main-card { padding: 20px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="main-card">
        <h1>ğŸ“Š Oliver Kell ç­–ç•¥åˆ†æå™¨ <span style="font-size:14px; color:#aaa; font-weight:normal;">(Pro Ultimate)</span></h1>
        
        <div class="alert-banner">
            <strong>âš ï¸ æ­¢æŸé“å¾‹ï¼š</strong>æ‰€æœ‰å‡çº¿æ­¢æŸ (Stop Loss) å‡ä»¥æ¯æ—¥ <strong>æ”¶ç›˜ä»· (Closing Price)</strong> ä¸ºå‡†ã€‚Oliver Kell å¼ºè°ƒ "Undercut & Reclaim" æ˜¯å¸¸è§æ´—ç›˜æ‰‹æ³•ï¼Œè¯·å‹¿åœ¨ç›˜ä¸­ææ…Œå–å‡ºã€‚
        </div>

        <div class="input-section">
            <input type="text" id="symbol" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç  (ä¾‹å¦‚: ERJ, TSLA)" value="ERJ">
            <button id="analyze-btn" class="analyze-btn" onclick="runAnalysis()">æ‰§è¡Œæ·±åº¦åˆ†æ</button>
        </div>
        <div id="error-message"></div>

        <div id="result-area" style="display:none;">
            
            <div class="cycle-grid">
                
                <div id="box-downtrend" class="cycle-box bearish">
                    <h3>1. ä¸‹è·Œ/ç­‘åº•</h3>
                    <div class="status-desc">
                        <p>Price < 20 EMA</p>
                        <p>ç­‰å¾…åè½¬å»¶ä¼¸ä¿¡å· (Reversal Extension)</p>
                    </div>
                    <span class="book-ref">Page 9: Process Step T</span>
                    <button class="show-detail-btn" onclick="toggleDetail('detail-downtrend')">æŸ¥çœ‹è¯¦ç»†æ ‡å‡† â–¼</button>
                </div>

                <div id="box-wedgepop" class="cycle-box">
                    <h3>2. æ¥”å½¢çªç ´</h3>
                    <div class="status-desc">
                        <p><strong>æ”¶ç›˜ä»·</strong> æ”¶å¤ 10/20 EMA</p>
                        <p>ç¡®è®¤åè½¬æœ‰æ•ˆ (Confirmation)</p>
                    </div>
                    <span class="book-ref">Page 10: Wedge Pop</span>
                    <button class="show-detail-btn" onclick="toggleDetail('detail-wedgepop')">æŸ¥çœ‹åˆå§‹æ­¢æŸ â–¼</button>
                </div>

                <div id="box-uptrend" class="cycle-box">
                    <h3>3. ä¸Šå‡è¶‹åŠ¿</h3>
                    <div class="status-desc">
                        <p>æ”¶ç›˜ä»· > 20 EMA</p>
                        <p>éª‘ä¹˜å‡çº¿ (Ride the MAs)</p>
                    </div>
                    <span class="book-ref">Page 14: Step T Continued</span>
                    <button class="show-detail-btn" onclick="toggleDetail('detail-uptrend')">æŸ¥çœ‹æ“ä½œæŒ‡ä»¤ â–¼</button>
                </div>

                <div id="box-wedgedrop" class="cycle-box bearish">
                    <h3>4. è¶‹åŠ¿ç»ˆç»“</h3>
                    <div class="status-desc">
                        <p style="color:var(--danger-red); font-weight:bold;">âš ï¸ ç¦»åœºè­¦æŠ¥</p>
                        <p><strong>æ”¶ç›˜ä»·è·Œç ´</strong> 20 EMA</p>
                    </div>
                    <span class="book-ref">Page 12: Wedge Drop</span>
                    <button class="show-detail-btn" onclick="toggleDetail('detail-wedgedrop')">æŸ¥çœ‹å–å‡ºåˆ¤å®š â–¼</button>
                </div>

                <div id="detail-downtrend" class="detail-section">
                    <div class="detail-card-inner">
                        <ul class="strategy-list">
                            <li class="strategy-item">
                                <div class="item-header"><span class="item-title">A. å¤§å‘¨æœŸæ”¯æ’‘ (Higher Timeframe)</span><span class="badge badge-manual">éœ€äººå·¥ç¡®è®¤</span></div>
                                <div class="item-desc">ä»£ç åªèƒ½åˆ†ææ—¥çº¿ã€‚è¯·åŠ¡å¿…æ£€æŸ¥å‘¨çº¿ (Weekly) æ˜¯å¦åˆ°è¾¾å…³é”®æ”¯æ’‘ä½ã€‚</div>
                                <div class="book-quote-box">"Look for a defined support level on a higher timeframe." (Page 9)</div>
                            </li>
                            <li class="strategy-item">
                                <div class="item-header"><span class="item-title">B. å‡çº¿ç©ºé—´ (Air)</span><span id="check-air" class="badge">--</span></div>
                                <div class="item-desc">ä»·æ ¼å¿…é¡»åœ¨ 10 EMA ä¸‹æ–¹ (Price &lt; 10 EMA)ï¼Œäº§ç”Ÿè´Ÿä¹–ç¦»ã€‚</div>
                            </li>
                            <li class="strategy-item">
                                <div class="item-header"><span class="item-title">C. åè½¬ K çº¿ + æ”¾é‡</span><span id="check-rev" class="badge">--</span></div>
                                <div class="item-desc">éœ€è¦æ”¶ç›˜ä»· > å¼€ç›˜ä»· (é˜³çº¿) ä¸” æˆäº¤é‡æ”¾å¤§ (Capitulation)ã€‚</div>
                                <div class="book-quote-box">"Heavy volume capitulation on the reversal bar is a key ingredient." (Page 9)</div>
                            </li>
                        </ul>
                    </div>
                </div>

                <div id="detail-wedgepop" class="detail-section">
                    <div class="detail-card-inner">
                        <p style="font-weight:bold; margin-bottom:15px;">åˆå§‹æ­¢æŸ (Initial Stop) çš„ä¸¤ä¸ªé€‰æ‹©ï¼š</p>
                        <ul class="strategy-list">
                            <li class="strategy-item">
                                <div class="item-header"><span class="item-title">é€‰æ‹© 1: è¿‘æœŸç›˜æ•´åŒºä½ç‚¹</span><span class="badge badge-stop">CLOSE STOP</span></div>
                                <div class="item-desc">é€‚ç”¨äºçªç ´å‰æœ‰æ¨ªç›˜æ•´ç†ã€‚ä»¥æ”¶ç›˜è·Œç ´ç›˜æ•´åŒºä¸‹æ²¿ä¸ºæ­¢æŸã€‚</div>
                                <div class="book-quote-box">"Stop below the near-term price consolidation." (Page 10)</div>
                            </li>
                            <li class="strategy-item">
                                <div class="item-header"><span class="item-title">é€‰æ‹© 2: çªç ´æ—¥ä½ç‚¹</span><span class="badge badge-stop">CLOSE STOP</span></div>
                                <div class="item-desc">é€‚ç”¨äºçˆ†å‘æ€§å•æ—¥çªç ´ã€‚ä»¥æ”¶ç›˜è·Œç ´çªç ´æ—¥å½“å¤©çš„æœ€ä½ä»·ä¸ºæ­¢æŸã€‚</div>
                                <div class="book-quote-box">"Stops raised to below the breakout dayâ€™s low." (Page 58)</div>
                            </li>
                        </ul>
                    </div>
                </div>

                <div id="detail-uptrend" class="detail-section">
                    <div class="detail-card-inner">
                        <ul class="strategy-list">
                            <li class="strategy-item">
                                <div class="item-header"><span class="item-title">å‡çº¿å›è¸© (EMA Crossback)</span><span class="badge badge-action">ADD / BUY</span></div>
                                <div class="item-desc">å½“ä»·æ ¼å›è°ƒè§¦ç¢° 10/20 EMA æ—¶ä¹°å…¥ã€‚</div>
                                <div class="item-desc" style="color:#e53e3e;"><strong>æ­¢æŸï¼š</strong>æ”¶ç›˜ä»·è·Œç ´ 10/20 EMAï¼Œæˆ–å›è¸©æ—¥æœ€ä½ä»·ã€‚</div>
                                <div class="book-quote-box">"Buy against the 10/20 EMA... stops at a loss of the averages." (Page 13)</div>
                            </li>
                            <li class="strategy-item">
                                <div class="item-header"><span class="item-title">åº•å‡çªç ´ (Base n' Break)</span><span class="badge badge-action">ADD</span></div>
                                <div class="item-desc">ä»·æ ¼åˆ›å‡º 20 æ—¥æ–°é«˜æ—¶åŠ ä»“ã€‚æ­¢æŸä¸Šç§»è‡³å½¢æ€åº•éƒ¨ã€‚</div>
                            </li>
                            <li class="strategy-item">
                                <div class="item-header"><span class="item-title">å»¶ä¼¸ç‡è­¦ç¤º (Exhaustion)</span><span id="check-ext" class="badge">--</span></div>
                                <div class="item-desc">æ£€æŸ¥ä¹–ç¦»ç‡ã€‚2nd Extension æ˜¯æ­¢ç›ˆç‚¹ï¼Œ3rd Extension é€šå¸¸æ˜¯ç»ˆç‚¹ã€‚</div>
                            </li>
                        </ul>
                    </div>
                </div>

                <div id="detail-wedgedrop" class="detail-section">
                    <div class="detail-card-inner">
                        <ul class="strategy-list">
                            <li class="strategy-item">
                                <div class="item-header"><span class="item-title">äººå·¥åˆ¤æ–­ (Judgement Call)</span><span class="badge badge-manual">é‡è¦</span></div>
                                <div class="item-desc">è§‚å¯Ÿ K çº¿å†å²ï¼šè¿™åªè‚¡ç¥¨æ˜¯å°Šé‡ 10 EMA è¿˜æ˜¯ 20 EMAï¼Ÿ</div>
                                <ul style="font-size:13px; margin-top:10px; color:#4a5568;">
                                    <li>è‹¥å°Šé‡ 10 EMA â” <strong>æ”¶ç›˜ç ´ 10 EMA å‡ä»“/ç¦»åœºã€‚</strong></li>
                                    <li>è‹¥å°Šé‡ 20 EMA â” <strong>æ”¶ç›˜ç ´ 20 EMA æ˜¯æœ€åé˜²çº¿ã€‚</strong></li>
                                </ul>
                                <div class="book-quote-box">"Determining which MA a stock is respecting is a judgement call." (Page 23)</div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="metrics-container">
                <div class="metric-card">
                    <div class="metric-title">å½“å‰æ”¶ç›˜ä»·</div>
                    <div class="metric-value" id="val-price">--</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">10 EMA (çŸ­æœŸ)</div>
                    <div class="metric-value val-ema10" id="val-ema10">--</div>
                </div>
                <div class="metric-card" style="border-bottom: 4px solid var(--primary-blue);">
                    <div class="metric-title">20 EMA (ç”Ÿæ­»çº¿)</div>
                    <div class="metric-value val-ema20" id="val-ema20">--</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">10æ—¥å»¶ä¼¸ç‡</div>
                    <div class="metric-value" id="val-ext">--</div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // åˆ‡æ¢è¯¦æƒ…å¡ç‰‡
    function toggleDetail(id) {
        const el = document.getElementById(id);
        const all = document.querySelectorAll('.detail-section');
        const isVisible = el.style.display === 'block';
        all.forEach(d => d.style.display = 'none'); // å…³é—­å…¶ä»–
        if (!isVisible) el.style.display = 'block'; // åˆ‡æ¢å½“å‰
    }

    // EMA è®¡ç®—
    function calculateEMA(prices, period) {
        if (prices.length < period) return [];
        const k = 2 / (period + 1);
        let emaArray = [prices.slice(0, period).reduce((a,b)=>a+b,0)/period];
        for(let i = period; i < prices.length; i++) {
            emaArray.push(prices[i] * k + emaArray[emaArray.length - 1] * (1 - k));
        }
        return emaArray;
    }

    // ä¸»è¿è¡Œå‡½æ•° (å¯¹æ¥çœŸå® API)
    async function runAnalysis() {
        const symbol = document.getElementById('symbol').value.trim().toUpperCase();
        const btn = document.getElementById('analyze-btn');
        const errorDiv = document.getElementById('error-message');
        const resultArea = document.getElementById('result-area');

        if(!symbol) { alert("è¯·è¾“å…¥è‚¡ç¥¨ä»£ç "); return; }

        // é‡ç½®çŠ¶æ€
        btn.disabled = true;
        btn.textContent = "API è¯·æ±‚ä¸­...";
        errorDiv.style.display = 'none';
        resultArea.style.display = 'none';
        document.querySelectorAll('.cycle-box').forEach(el => el.classList.remove('active', 'bearish'));
        // æ¢å¤é»˜è®¤é¢œè‰²ç±»
        document.getElementById('box-downtrend').classList.add('bearish');
        document.getElementById('box-wedgedrop').classList.add('bearish');

        try {
            // =================================================================
            // çœŸå® API è¯·æ±‚ (å·²æ¢å¤ä¸º API æ¨¡å¼)
            // =================================================================
            const response = await fetch(`/api/stock?symbol=${symbol}`);
            
            if (!response.ok) {
                throw new Error(`ç½‘ç»œè¯·æ±‚å¤±è´¥ (Status: ${response.status})`);
            }
            
            const data = await response.json();

            // æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
            if (!data["Time Series (Daily)"]) {
                throw new Error("API è¿”å›æ•°æ®ä¸ºç©ºï¼Œè¯·æ£€æŸ¥ä»£ç æ‹¼å†™æˆ– Key é¢åº¦");
            }

            const timeSeries = data["Time Series (Daily)"];
            const dates = Object.keys(timeSeries).sort(); // æ—¥æœŸå‡åº

            // æå–æ ¸å¿ƒæ•°æ®
            const closePrices = dates.map(d => parseFloat(timeSeries[d]["4. close"]));
            const openPrices = dates.map(d => parseFloat(timeSeries[d]["1. open"]));
            const volumes = dates.map(d => parseFloat(timeSeries[d]["5. volume"]));

            if(closePrices.length < 50) throw new Error("å†å²æ•°æ®ä¸è¶³ (å°‘äº50å¤©)ï¼Œæ— æ³•ç²¾å‡†è®¡ç®—å‡çº¿");

            // è®¡ç®—å‡çº¿
            const ema10Array = calculateEMA(closePrices, 10);
            const ema20Array = calculateEMA(closePrices, 20);

            // è·å–æœ€æ–°æ•°æ®ç‚¹ (Last Index)
            const lastIdx = closePrices.length - 1;
            const curClose = closePrices[lastIdx];
            const prevClose = closePrices[lastIdx - 1];
            const curOpen = openPrices[lastIdx];
            const curVol = volumes[lastIdx];
            // è®¡ç®— 20æ—¥å¹³å‡æˆäº¤é‡
            const avgVol = volumes.slice(lastIdx - 20, lastIdx).reduce((a,b)=>a+b,0) / 20;

            const curEma10 = ema10Array[ema10Array.length - 1];
            const curEma20 = ema20Array[ema20Array.length - 1];
            const prevEma20 = ema20Array[ema20Array.length - 2];

            // =================================================================
            // åˆ¤å®šé€»è¾‘
            // =================================================================
            
            let activeBoxId = "";
            
            // Wedge Drop: æ˜¨å¤© > 20MA, ä»Šå¤© < 20MA
            if (prevClose >= prevEma20 && curClose < curEma20) {
                activeBoxId = "box-wedgedrop";
            }
            // Wedge Pop: æ˜¨å¤© < 20MA, ä»Šå¤© > 20MA
            else if (prevClose < prevEma20 && curClose > curEma20) {
                activeBoxId = "box-wedgepop";
            }
            // Uptrend: æŒç»­åœ¨ 20MA ä¸Šæ–¹
            else if (curClose >= curEma20) {
                activeBoxId = "box-uptrend";
            }
            // Downtrend: æŒç»­åœ¨ 20MA ä¸‹æ–¹
            else {
                activeBoxId = "box-downtrend";
            }
            
            document.getElementById(activeBoxId).classList.add('active');

            // =================================================================
            // è¯¦æƒ…å¡«å……é€»è¾‘
            // =================================================================
            
            // Downtrend æ£€æŸ¥
            const isAir = curClose < curEma10;
            const isRevBar = curClose > curOpen; 
            const isCapitulation = curVol > avgVol;

            document.getElementById('check-air').innerHTML = isAir 
                ? '<span class="badge badge-action">YES (Air)</span>' 
                : '<span class="badge">NO</span>';
            
            document.getElementById('check-rev').innerHTML = (isRevBar && isCapitulation) 
                ? '<span class="badge badge-action">YES (Combo)</span>' 
                : '<span class="badge">Wait</span>';

            // Uptrend Extension æ£€æŸ¥
            const extPct = ((curClose - curEma10) / curEma10) * 100;
            let extHtml = "";
            if(extPct > 20) extHtml = `<span class="badge badge-stop">DANGER (${extPct.toFixed(1)}%)</span>`;
            else if(extPct > 10) extHtml = `<span class="badge badge-manual">Extended (${extPct.toFixed(1)}%)</span>`;
            else extHtml = `<span class="badge badge-action">Healthy (${extPct.toFixed(1)}%)</span>`;
            
            document.getElementById('check-ext').innerHTML = extHtml;

            // =================================================================
            // æ•°æ®æ¸²æŸ“
            // =================================================================
            resultArea.style.display = 'block';
            
            document.getElementById('val-price').textContent = "$" + curClose.toFixed(2);
            document.getElementById('val-ema10').textContent = "$" + curEma10.toFixed(2);
            document.getElementById('val-ema20').textContent = "$" + curEma20.toFixed(2);
            document.getElementById('val-ext').textContent = extPct.toFixed(2) + "%";

            // è§†è§‰é«˜äº®ï¼šå¦‚æœç ´ä½ï¼Œä»·æ ¼å˜çº¢
            if (curClose < curEma20) {
                document.getElementById('val-price').style.color = "#e53e3e";
            } else {
                document.getElementById('val-price').style.color = "#2d3748";
            }

        } catch (err) {
            console.error(err);
            errorDiv.innerHTML = `<strong>â›” è¿è¡Œå‡ºé”™:</strong> ${err.message}`;
            errorDiv.style.display = 'block';
        } finally {
            btn.disabled = false;
            btn.textContent = "æ‰§è¡Œæ·±åº¦åˆ†æ";
        }
    }
</script>

</body>
</html>
