<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oliver Kell ç­–ç•¥åˆ†æå™¨ (Vercel ç‰ˆ)</title>
    <style>
        /* æ ·å¼ä¿æŒä¸å˜ï¼Œä¸ºäº†ç¯‡å¹…çœç•¥ï¼Œç›´æ¥ç”¨ä¹‹å‰çš„ CSS */
        body { font-family: 'Segoe UI', Tahoma, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; background-color: #f5f7fa; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; }
        .input-group { margin-bottom: 20px; display: flex; gap: 10px; }
        input { padding: 12px; border: 1px solid #ddd; border-radius: 6px; flex: 1; font-size: 16px; }
        button { padding: 12px 24px; background-color: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        #result { margin-top: 30px; display: none; }
        .status-box { padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .status-bullish { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-bearish { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status-neutral { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .metric-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .metric-item { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; }
        .metric-value { font-size: 20px; font-weight: bold; margin-top: 5px; }
        .signal-badge { display: inline-block; padding: 5px 10px; border-radius: 20px; font-size: 14px; font-weight: bold; margin-top: 5px; background: #eee;}
        .signal-buy { background-color: #27ae60; color: white; }
        .signal-sell { background-color: #c0392b; color: white; }
    </style>
</head>
<body>

<div class="card">
    <h1>ğŸ“Š Oliver Kell ç­–ç•¥åˆ†æå™¨</h1>
    <p style="color: #666; margin-bottom: 25px;">å®‰å…¨ç‰ˆï¼šAPI Key å·²åœ¨æœåŠ¡å™¨ç«¯åŠ å¯†ä¿æŠ¤ã€‚</p>
    
    <div class="input-group">
        <input type="text" id="symbol" placeholder="è‚¡ç¥¨ä»£ç  (ä¾‹å¦‚: AAPL)" value="TSLA">
        <button id="analyzeBtn" onclick="analyzeStock()">å¼€å§‹åˆ†æ</button>
    </div>
    <div id="errorMsg" style="color: red; margin-top: 10px; display: none;"></div>

    <div id="result">
        <div id="statusBox" class="status-box">
            <h2 id="trendTitle" style="margin: 0 0 10px 0;">--</h2>
            <p id="trendDesc" style="margin: 0;"></p>
            <div id="signalContainer" style="margin-top:10px;"></div>
        </div>
        <div class="metric-grid">
            <div class="metric-item"><div>å½“å‰ä»·æ ¼</div><div class="metric-value" id="priceVal">--</div></div>
            <div class="metric-item"><div>10 æ—¥ EMA</div><div class="metric-value" id="ema10Val">--</div></div>
            <div class="metric-item"><div>20 æ—¥ EMA</div><div class="metric-value" id="ema20Val">--</div></div>
            <div class="metric-item"><div>ä¹–ç¦»ç‡</div><div class="metric-value" id="extensionVal">--</div></div>
        </div>
    </div>
</div>

<script>
    // EMA è®¡ç®—é€»è¾‘ä¿æŒä¸å˜
    function calculateEMA(prices, period) {
        const k = 2 / (period + 1);
        let emaArray = [prices.slice(0, period).reduce((a,b)=>a+b,0)/period];
        for(let i = period; i < prices.length; i++) {
            emaArray.push((prices[i] * k) + (emaArray[emaArray.length - 1] * (1 - k)));
        }
        return emaArray;
    }

    async function analyzeStock() {
        const symbol = document.getElementById('symbol').value.trim().toUpperCase();
        const btn = document.getElementById('analyzeBtn');
        const errorDiv = document.getElementById('errorMsg');
        const resultDiv = document.getElementById('result');

        btn.disabled = true;
        btn.textContent = "åˆ†æä¸­...";
        errorDiv.style.display = 'none';
        resultDiv.style.display = 'none';

        try {
            // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šè¿™é‡Œä¸å†ç›´æ¥è¯·æ±‚ alphavantageï¼Œè€Œæ˜¯è¯·æ±‚ä½ çš„åç«¯ api â˜…â˜…â˜…
            const response = await fetch(`/api/stock?symbol=${symbol}`);
            const data = await response.json();

            if (!response.ok) throw new Error(data.error || "è¯·æ±‚å¤±è´¥");
            if (data["Error Message"]) throw new Error("æ— æ•ˆçš„ä»£ç ");
            if (data["Note"]) throw new Error("API é¢‘ç‡é™åˆ¶ï¼Œè¯·ç¨åå†è¯•");
            
            const timeSeries = data["Time Series (Daily)"];
            if (!timeSeries) throw new Error("æ— æ³•è·å–æ•°æ®");

            // æ•°æ®å¤„ç†é€»è¾‘ä¸ä¹‹å‰å®Œå…¨ä¸€è‡´
            const dates = Object.keys(timeSeries).sort(); 
            const prices = dates.map(date => parseFloat(timeSeries[date]["4. close"]));
            if (prices.length < 50) throw new Error("å†å²æ•°æ®ä¸è¶³");

            const ema10Array = calculateEMA(prices, 10);
            const ema20Array = calculateEMA(prices, 20);
            const currentPrice = prices[prices.length - 1];
            const prevPrice = prices[prices.length - 2];
            
            // å¯¹é½æ•°æ®
            const currentEma10 = ema10Array[ema10Array.length - 1];
            const currentEma20 = ema20Array[ema20Array.length - 1];
            const prevEma20 = ema20Array[ema20Array.length - 2];

            // ç­–ç•¥åˆ¤æ–­é€»è¾‘
            let statusClass = "status-neutral";
            let trendText = "éœ‡è¡/ä¸­æ€§";
            let trendDesc = "æ–¹å‘ä¸æ˜ç¡®";
            let signals = [];

            const isAbove20 = currentPrice > currentEma20;
            const isAbove10 = currentPrice > currentEma10;

            if (isAbove20 && isAbove10) {
                statusClass = "status-bullish";
                trendText = "ğŸš€ ä¸Šå‡è¶‹åŠ¿ (Phase 2)";
                trendDesc = "ç«™ç¨³ 10/20 EMA ä¹‹ä¸Š";
            } else if (!isAbove20) {
                statusClass = "status-bearish";
                trendText = "ğŸ”» ä¸‹è·Œè¶‹åŠ¿";
                trendDesc = "ä½äº 20 EMA ä¸‹æ–¹";
            }

            if (prevPrice < prevEma20 && currentPrice > currentEma20) signals.push({type:'buy', text:"Wedge Pop (ä¹°ç‚¹)"});
            if (isAbove20 && currentPrice <= currentEma10*1.01 && currentPrice > currentEma20) signals.push({type:'buy', text:"EMA Crossback (ä½å¸)"});
            if (prevPrice > prevEma20 && currentPrice < currentEma20) signals.push({type:'sell', text:"Wedge Drop (å–å‡º)"});
            
            const extension = (currentPrice - currentEma10) / currentEma10;
            if (extension > 0.15) signals.push({type:'sell', text:`âš ï¸ å»¶ä¼¸è¿‡åº¦ ${(extension*100).toFixed(1)}%`});

            // æ¸²æŸ“
            document.getElementById('statusBox').className = "status-box " + statusClass;
            document.getElementById('trendTitle').textContent = trendText;
            document.getElementById('trendDesc').textContent = trendDesc;
            document.getElementById('priceVal').textContent = "$" + currentPrice.toFixed(2);
            document.getElementById('ema10Val').textContent = "$" + currentEma10.toFixed(2);
            document.getElementById('ema20Val').textContent = "$" + currentEma20.toFixed(2);
            document.getElementById('extensionVal').textContent = (extension * 100).toFixed(1) + "%";

            const sigCont = document.getElementById('signalContainer');
            sigCont.innerHTML = '';
            signals.forEach(sig => {
                const b = document.createElement('div');
                b.className = `signal-badge ${sig.type==='buy'?'signal-buy':'signal-sell'}`;
                b.textContent = sig.text;
                sigCont.appendChild(b);
            });
            resultDiv.style.display = 'block';

        } catch (err) {
            errorDiv.textContent = "é”™è¯¯: " + err.message;
            errorDiv.style.display = 'block';
        } finally {
            btn.disabled = false;
            btn.textContent = "å¼€å§‹åˆ†æ";
        }
    }
</script>
</body>
</html>
