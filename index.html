<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oliver Kell Strategy Analyzer (Quant Ultimate)</title>
    <style>
        /* =========================================
           1. é«˜çº§è§†è§‰ç³»ç»Ÿ (Design System)
           ========================================= */
        :root {
            --primary: #3182ce;       /* æ ¸å¿ƒè“ */
            --primary-dark: #2c5282;  /* æ·±è“äº¤äº’ */
            --accent: #805ad5;        /* 20EMA ç´«è‰² */
            --danger: #e53e3e;        /* è­¦å‘Šçº¢ */
            --success: #38a169;       /* é€šè¿‡ç»¿ */
            --warning: #d69e2e;       /* 10EMA é»„ */
            --bg-color: #f7f9fc;
            --card-bg: #ffffff;
            --text-main: #2d3748;
            --text-sub: #718096;
            --shadow-card: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-hover: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 40px 20px;
            line-height: 1.6;
        }

        .container { max-width: 980px; margin: 0 auto; }

        /* ä¸»å¡ç‰‡ */
        .main-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 40px;
            box-shadow: var(--shadow-card);
            border: 1px solid #edf2f7;
            transition: all 0.3s ease;
        }

        /* æ ‡é¢˜åŒº */
        h1 {
            margin-top: 0;
            font-size: 28px;
            letter-spacing: -0.5px;
            border-bottom: 2px solid #edf2f7;
            padding-bottom: 15px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .version-tag {
            font-size: 12px;
            background: #ebf8ff;
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 700;
            text-transform: uppercase;
        }

        /* è­¦å‘Šæ¨ªå¹… - å¼ºè°ƒæ”¶ç›˜æ­¢æŸ */
        .alert-banner {
            background-color: #fffaf0;
            border-left: 5px solid var(--warning);
            padding: 15px 20px;
            border-radius: 6px;
            margin-bottom: 30px;
            color: #744210;
            font-size: 14px;
            display: flex;
            align-items: center;
        }
        .alert-icon { margin-right: 10px; font-size: 18px; }

        /* è¾“å…¥åŒºåŸŸ */
        .input-section { display: flex; gap: 15px; margin-bottom: 10px; }
        
        input[type="text"] {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 18px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
            font-family: monospace; /* è‚¡ç¥¨ä»£ç ç­‰å®½ */
            text-transform: uppercase;
        }
        
        input[type="text"]:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.15);
        }

        .analyze-btn {
            padding: 0 40px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(49, 130, 206, 0.2);
        }
        
        .analyze-btn:hover { background-color: var(--primary-dark); transform: translateY(-1px); }
        .analyze-btn:disabled { background-color: #cbd5e0; cursor: not-allowed; transform: none; box-shadow: none; }

        #error-message {
            background: #fff5f5; color: var(--danger); border: 1px solid #fed7d7;
            padding: 15px; border-radius: 8px; margin-top: 20px; display: none; font-weight: 500;
        }

        /* =========================================
           2. æ ¸å¿ƒå‘¨æœŸç½‘æ ¼ (Cycle Grid)
           ========================================= */
        .cycle-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-top: 40px;
        }

        .cycle-box {
            background: #edf2f7;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid transparent;
            opacity: 0.5;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            min-height: 220px; /* å¢åŠ é«˜åº¦ä»¥å®¹çº³æ›´å¤šä¿¡æ¯ */
            display: flex;
            flex-direction: column;
        }

        /* æ¿€æ´»çŠ¶æ€ */
        .cycle-box.active {
            opacity: 1;
            background-color: #fff;
            border-color: var(--primary);
            box-shadow: var(--shadow-hover);
            transform: translateY(-8px);
            z-index: 10;
        }
        
        .cycle-box.bearish.active { border-color: var(--danger); }

        .cycle-box h3 { margin: 0 0 10px 0; font-size: 16px; font-weight: 800; color: var(--text-main); }
        .status-desc { font-size: 13px; color: var(--text-sub); margin-bottom: auto; line-height: 1.5; }
        
        .book-ref {
            font-size: 11px; color: #a0aec0; font-style: italic; margin-top: 15px;
            border-top: 1px solid #e2e8f0; padding-top: 8px;
        }

        .show-detail-btn {
            background: none; border: none; color: var(--primary); font-size: 12px;
            font-weight: bold; cursor: pointer; margin-top: 10px; text-align: left;
            padding: 0; text-decoration: underline;
        }

        /* =========================================
           3. è¯¦æƒ…å¡ç‰‡ä¸é‡åŒ–æŒ‡æ ‡ (Quant Details)
           ========================================= */
        .detail-section {
            grid-column: 1 / -1;
            display: none;
            animation: slideDown 0.4s ease-out;
            margin-top: 10px;
        }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .detail-card-inner {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-left: 5px solid var(--primary);
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .strategy-list { list-style: none; padding: 0; margin: 0; }
        .strategy-item {
            padding-bottom: 15px; margin-bottom: 15px; border-bottom: 1px dashed #e2e8f0;
            display: flex; flex-direction: column;
        }
        .strategy-item:last-child { border-bottom: none; margin-bottom: 0; }

        .item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .item-title { font-weight: 700; font-size: 14px; color: var(--text-main); }
        .item-desc { font-size: 13px; color: #4a5568; }

        /* å¾½ç« ç³»ç»Ÿ (Badges) */
        .badge {
            font-size: 10px; text-transform: uppercase; padding: 3px 8px; border-radius: 4px;
            font-weight: 800; letter-spacing: 0.5px; margin-left: 8px;
        }
        .badge-yes { background-color: #f0fff4; color: var(--success); border: 1px solid #c6f6d5; }
        .badge-no { background-color: #edf2f7; color: #a0aec0; border: 1px solid #e2e8f0; }
        .badge-stop { background-color: #fff5f5; color: var(--danger); border: 1px solid #fed7d7; }
        .badge-manual { background-color: #fffaf0; color: #b7791f; border: 1px solid #fbd38d; }
        .badge-buy { background-color: var(--primary); color: white; }

        .book-quote-box {
            background-color: #f7fafc; padding: 8px 12px; border-radius: 4px;
            font-size: 12px; color: #718096; font-style: italic; margin-top: 8px;
            border-left: 3px solid #cbd5e0;
        }

        /* =========================================
           4. ä»ªè¡¨ç›˜ (Metrics)
           ========================================= */
        .metrics-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px; margin-top: 40px; padding-top: 30px; border-top: 2px dashed #e2e8f0;
        }
        .metric-card {
            background: #f8fafc; padding: 20px; border-radius: 12px; text-align: center;
            border: 1px solid #e2e8f0; transition: transform 0.2s;
        }
        .metric-card:hover { transform: translateY(-2px); border-color: #cbd5e0; }
        
        .metric-title { font-size: 11px; text-transform: uppercase; color: #a0aec0; font-weight: 700; margin-bottom: 8px; }
        .metric-value { font-size: 26px; font-weight: 800; color: var(--text-main); font-family: "SF Mono", "Menlo", monospace; }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .cycle-grid { grid-template-columns: 1fr 1fr; }
            .container { padding: 20px 10px; }
            .main-card { padding: 20px; }
            h1 { font-size: 22px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="main-card">
        <h1>
            <span>ğŸ“Š Oliver Kell ç­–ç•¥åˆ†æå™¨</span>
            <span class="version-tag">Quant Edition</span>
        </h1>
        
        <div class="alert-banner">
            <span class="alert-icon">âš–ï¸</span>
            <div>
                <strong>æ­¢æŸé“å¾‹ï¼š</strong>æ‰€æœ‰å‡çº¿æ­¢æŸ (Stop Loss) å‡ä»¥æ¯æ—¥ <strong>æ”¶ç›˜ä»· (Closing Price)</strong> ä¸ºå‡†ã€‚
                <br>ç›˜ä¸­åˆºç ´ (Undercut) å¸¸ä¸ºæ´—ç›˜ï¼Œè¯·å‹¿åœ¨ç›˜ä¸­ææ…Œå–å‡ºã€‚
            </div>
        </div>

        <div class="input-section">
            <input type="text" id="symbol" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç  (ä¾‹å¦‚: ERJ, NVDA)" value="ERJ">
            <button id="analyze-btn" class="analyze-btn" onclick="runAnalysis()">æ‰§è¡Œé‡åŒ–åˆ†æ</button>
        </div>
        <div id="error-message"></div>

        <div id="result-area" style="display:none;">
            
            <div class="cycle-grid">
                
                <div id="box-downtrend" class="cycle-box bearish">
                    <h3>1. ä¸‹è·Œ/ç­‘åº•</h3>
                    <div class="status-desc">
                        <p>Price < 20 EMA</p>
                        <p>ç­‰å¾… Reversal Extension ä¿¡å·</p>
                    </div>
                    <span class="book-ref">Page 9: Process Step T</span>
                    <button class="show-detail-btn" onclick="toggleDetail('detail-downtrend')">æŸ¥çœ‹ç­‘åº•é‡åŒ–æŒ‡æ ‡ â–¼</button>
                </div>

                <div id="box-wedgepop" class="cycle-box">
                    <h3>2. æ¥”å½¢çªç ´</h3>
                    <div class="status-desc">
                        <p><strong>æ”¶ç›˜ä»·</strong> ç«™ä¸Š 10/20 EMA</p>
                        <p>è¶‹åŠ¿åè½¬ç¡®è®¤</p>
                    </div>
                    <span class="book-ref">Page 10: Wedge Pop</span>
                    <button class="show-detail-btn" onclick="toggleDetail('detail-wedgepop')">æŸ¥çœ‹åˆå§‹æ­¢æŸæ–¹æ¡ˆ â–¼</button>
                </div>

                <div id="box-uptrend" class="cycle-box">
                    <h3>3. ä¸Šå‡è¶‹åŠ¿</h3>
                    <div class="status-desc">
                        <p>æ”¶ç›˜ä»· > 20 EMA</p>
                        <p>éª‘ä¹˜å‡çº¿ (Ride the MAs)</p>
                    </div>
                    <span class="book-ref">Page 14: Step T Continued</span>
                    <button class="show-detail-btn" onclick="toggleDetail('detail-uptrend')">æŸ¥çœ‹ä¹°å…¥/åŠ ä»“ä¿¡å· â–¼</button>
                </div>

                <div id="box-wedgedrop" class="cycle-box bearish">
                    <h3>4. è¶‹åŠ¿ç»ˆç»“</h3>
                    <div class="status-desc">
                        <p style="color:var(--danger); font-weight:bold;">âš ï¸ ç¦»åœºä¿¡å·</p>
                        <p><strong>æ”¶ç›˜ä»·è·Œç ´</strong> 20 EMA</p>
                    </div>
                    <span class="book-ref">Page 12: Wedge Drop</span>
                    <button class="show-detail-btn" onclick="toggleDetail('detail-wedgedrop')">æŸ¥çœ‹å–å‡ºåˆ¤å®š â–¼</button>
                </div>

                <div id="detail-downtrend" class="detail-section">
                    <div class="detail-card-inner">
                        <ul class="strategy-list">
                            <li class="strategy-item">
                                <div class="item-header"><span class="item-title">A. å‡çº¿ç©ºé—´ (Air Check)</span><span id="q-air" class="badge">--</span></div>
                                <div class="item-desc">ä»·æ ¼æ˜¯å¦å¤„äº 10 EMA ä¸‹æ–¹ (Price &lt; 10 EMA)? åªæœ‰è¿œç¦»å‡çº¿æ‰æœ‰ç©ºé—´åå¼¹ã€‚</div>
                            </li>
                            <li class="strategy-item">
                                <div class="item-header"><span class="item-title">B. åè½¬ K çº¿ (Reversal Bar)</span><span id="q-revbar" class="badge">--</span></div>
                                <div class="item-desc">ä»Šæ—¥æ”¶ç›˜ä»·æ˜¯å¦é«˜äºå¼€ç›˜ä»· (Close &gt; Open)?</div>
                            </li>
                            <li class="strategy-item">
                                <div class="item-header"><span class="item-title">C. æ”¾é‡ç¡®è®¤ (Capitulation)</span><span id="q-vol" class="badge">--</span></div>
                                <div class="item-desc">ä»Šæ—¥æˆäº¤é‡æ˜¯å¦å¤§äº 20æ—¥å‡é‡? (é‡æ¯” &gt; 1.0)</div>
                                <div class="book-quote-box">"Heavy volume capitulation on the reversal bar is a key ingredient." (Page 9)</div>
                            </li>
                        </ul>
                    </div>
                </div>

                <div id="detail-wedgepop" class="detail-section">
                    <div class="detail-card-inner">
                        <ul class="strategy-list">
                            <li class="strategy-item">
                                <div class="item-header"><span class="item-title">æ­¢æŸæ–¹æ¡ˆ A: ç›˜æ•´ä½ç‚¹</span><span class="badge badge-stop">CLOSE STOP</span></div>
                                <div class="item-desc">é€‚ç”¨äºçªç ´å‰æœ‰æ¨ªç›˜æ•´ç†ã€‚ä»¥æ”¶ç›˜è·Œç ´ç›˜æ•´åŒºä¸‹æ²¿ä¸ºæ­¢æŸã€‚</div>
                            </li>
                            <li class="strategy-item">
                                <div class="item-header"><span class="item-title">æ­¢æŸæ–¹æ¡ˆ B: çªç ´æ—¥ä½ç‚¹</span><span class="badge badge-stop">CLOSE STOP</span></div>
                                <div class="item-desc">é€‚ç”¨äºçˆ†å‘æ€§å•æ—¥çªç ´ã€‚ä»¥æ”¶ç›˜è·Œç ´çªç ´æ—¥å½“å¤©çš„æœ€ä½ä»·ä¸ºæ­¢æŸã€‚</div>
                                <div class="book-quote-box">"Stops raised to below the breakout dayâ€™s low." (Page 58)</div>
                            </li>
                        </ul>
                    </div>
                </div>

                <div id="detail-uptrend" class="detail-section">
                    <div class="detail-card-inner">
                        <ul class="strategy-list">
                            <li class="strategy-item">
                                <div class="item-header"><span class="item-title">å‡çº¿å›è¸© (Crossback)</span><span id="q-cross" class="badge">--</span></div>
                                <div class="item-desc">ä»Šæ—¥æœ€ä½ä»·æ˜¯å¦è§¦ç¢° 10 æˆ– 20 EMA? (Low &le; EMAs)</div>
                                <div class="item-desc" style="color:var(--primary); margin-top:5px; font-weight:bold;">ä¿¡å·: è‹¥æ˜¾ç¤º YESï¼Œä¸”æœªç ´ä½ï¼Œæ˜¯ç»ä½³ä¹°ç‚¹ã€‚</div>
                                <div class="book-quote-box">"Buy against the 10/20 EMA... stops at a loss of the averages." (Page 13)</div>
                            </li>
                            
                            <li class="strategy-item">
                                <div class="item-header"><span class="item-title">å¹³å°çªç ´ (Base Break)</span><span id="q-break" class="badge">--</span></div>
                                <div class="item-desc">æ”¶ç›˜ä»·æ˜¯å¦åˆ›è¿‡å» 20 å¤©æ–°é«˜? (Close &gt; 20D High)</div>
                                <div class="item-desc" style="color:var(--primary); margin-top:5px; font-weight:bold;">ä¿¡å·: è‹¥æ˜¾ç¤º YESï¼Œæ˜¯é¡ºåŠ¿åŠ ä»“ç‚¹ã€‚</div>
                            </li>

                            <li class="strategy-item">
                                <div class="item-header"><span class="item-title">å»¶ä¼¸ç‡è­¦ç¤º (Extension)</span><span id="q-ext" class="badge">--</span></div>
                                <div class="item-desc">è‚¡ä»·åç¦» 10 EMA çš„å¹…åº¦ã€‚>20% ä¸ºå±é™©åŒºåŸŸï¼Œ>10% ä¸ºè¿‡åº¦å»¶ä¼¸ã€‚</div>
                            </li>
                        </ul>
                    </div>
                </div>

                <div id="detail-wedgedrop" class="detail-section">
                    <div class="detail-card-inner">
                        <ul class="strategy-list">
                            <li class="strategy-item">
                                <div class="item-header"><span class="item-title">äººå·¥åˆ¤å®š (Judgment Call)</span><span class="badge badge-stop">SELL</span></div>
                                <div class="item-desc">è¯·è§‚å¯Ÿ K çº¿å†å²ï¼Œç¡®è®¤è‚¡ç¥¨"å°Šé‡"å“ªæ¡å‡çº¿ï¼š</div>
                                <ul style="font-size:13px; margin-top:8px; color:#4a5568;">
                                    <li>å¼ºåŠ¿è‚¡ (Respect 10) â” æ”¶ç›˜ç ´ 10 EMA å¿…é¡»å‡ä»“ã€‚</li>
                                    <li>è¶‹åŠ¿è‚¡ (Respect 20) â” <strong>æ”¶ç›˜ç ´ 20 EMA æ˜¯æœ€åé˜²çº¿ã€‚</strong></li>
                                </ul>
                                <div class="book-quote-box">"Determining which MA a stock is respecting is a judgement call." (Page 23)</div>
                            </li>
                        </ul>
                    </div>
                </div>

            </div>

            <div class="metrics-container">
                <div class="metric-card">
                    <div class="metric-title">å½“å‰æ”¶ç›˜ä»·</div>
                    <div class="metric-value" id="val-price">--</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">10 EMA (çŸ­æœŸ)</div>
                    <div class="metric-value" id="val-ema10" style="color:var(--warning)">--</div>
                </div>
                <div class="metric-card" style="border-bottom: 4px solid var(--accent);">
                    <div class="metric-title">20 EMA (ç”Ÿæ­»çº¿)</div>
                    <div class="metric-value" id="val-ema20" style="color:var(--accent)">--</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">10æ—¥å»¶ä¼¸ç‡</div>
                    <div class="metric-value" id="val-ext">--</div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // UI äº¤äº’å‡½æ•°
    function toggleDetail(id) {
        const el = document.getElementById(id);
        const all = document.querySelectorAll('.detail-section');
        const isVisible = el.style.display === 'block';
        
        // å…³é—­æ‰€æœ‰
        all.forEach(d => d.style.display = 'none');
        
        // å¦‚æœä¹‹å‰ä¸æ˜¯æ‰“å¼€çš„ï¼Œåˆ™æ‰“å¼€å½“å‰
        if (!isVisible) {
            el.style.display = 'block';
        }
    }

    // æ ¸å¿ƒç®—æ³•ï¼šè®¡ç®— EMA
    function calculateEMA(prices, period) {
        if (prices.length < period) return [];
        let k = 2 / (period + 1);
        // ç¬¬ä¸€å¤©ä½¿ç”¨ SMA ä½œä¸ºç§å­
        let emaArray = [prices.slice(0, period).reduce((a,b)=>a+b,0)/period];
        // é€’å½’è®¡ç®—
        for(let i = period; i < prices.length; i++) {
            emaArray.push(prices[i] * k + emaArray[emaArray.length - 1] * (1 - k));
        }
        return emaArray;
    }

    // ä¸»è¿è¡Œå‡½æ•°
    async function runAnalysis() {
        const symbol = document.getElementById('symbol').value.trim().toUpperCase();
        const btn = document.getElementById('analyze-btn');
        const errorDiv = document.getElementById('error-message');
        const resultArea = document.getElementById('result-area');

        if(!symbol) { alert("è¯·è¾“å…¥è‚¡ç¥¨ä»£ç "); return; }

        // çŠ¶æ€é‡ç½®
        btn.disabled = true;
        btn.textContent = "æ­£åœ¨è®¡ç®—é‡åŒ–æŒ‡æ ‡...";
        errorDiv.style.display = 'none';
        resultArea.style.display = 'none';
        
        // é‡ç½®æ‰€æœ‰æ–¹æ¡†æ ·å¼
        document.querySelectorAll('.cycle-box').forEach(el => el.classList.remove('active', 'bearish'));
        document.getElementById('box-downtrend').classList.add('bearish');
        document.getElementById('box-wedgedrop').classList.add('bearish');

        try {
            // =================================================================
            // 1. çœŸå® API è¯·æ±‚
            // =================================================================
            const response = await fetch(`/api/stock?symbol=${symbol}`);
            
            if (!response.ok) {
                throw new Error(`API è¯·æ±‚å¤±è´¥ (Status: ${response.status})`);
            }
            const data = await response.json();

            if (!data["Time Series (Daily)"]) {
                throw new Error("API è¿”å›ç©ºæ•°æ®ï¼Œè¯·æ£€æŸ¥ä»£ç æ‹¼å†™æˆ– Key é™é¢");
            }

            const timeSeries = data["Time Series (Daily)"];
            const dates = Object.keys(timeSeries).sort(); // æ—¥æœŸå‡åºæ’åˆ—

            // æå–æ•°æ®åˆ—
            const closePrices = dates.map(d => parseFloat(timeSeries[d]["4. close"]));
            const openPrices = dates.map(d => parseFloat(timeSeries[d]["1. open"]));
            const lowPrices = dates.map(d => parseFloat(timeSeries[d]["3. low"])); // éœ€è¦ Low æ¥åˆ¤æ–­è§¦ç¢°å‡çº¿
            const volumes = dates.map(d => parseFloat(timeSeries[d]["5. volume"]));

            if(closePrices.length < 50) throw new Error("å†å²æ•°æ®ä¸è¶³ 50 å¤©ï¼Œæ— æ³•ç²¾ç¡®è®¡ç®—å‡çº¿");

            // =================================================================
            // 2. æŒ‡æ ‡è®¡ç®—
            // =================================================================
            const ema10Array = calculateEMA(closePrices, 10);
            const ema20Array = calculateEMA(closePrices, 20);

            // è·å–æœ€æ–°ä¸€å¤©çš„ç´¢å¼• (Array Last Index)
            const lastIdx = closePrices.length - 1;
            
            // å½“å‰ K çº¿æ•°æ®
            const curClose = closePrices[lastIdx];
            const prevClose = closePrices[lastIdx - 1];
            const curOpen = openPrices[lastIdx];
            const curLow = lowPrices[lastIdx];
            const curVol = volumes[lastIdx];
            
            // 20æ—¥å‡é‡è®¡ç®—
            const avgVol = volumes.slice(lastIdx - 20, lastIdx).reduce((a,b)=>a+b,0) / 20;

            // EMA æ•°æ® (æ³¨æ„ EMA æ•°ç»„é•¿åº¦å¯èƒ½æ¯” Price çŸ­ï¼Œå–æœ€åä¸€ä¸ª)
            const curEma10 = ema10Array[ema10Array.length - 1];
            const curEma20 = ema20Array[ema20Array.length - 1];
            const prevEma20 = ema20Array[ema20Array.length - 2];

            // =================================================================
            // 3. æ ¸å¿ƒå‘¨æœŸåˆ¤å®š (Cycle Logic)
            // =================================================================
            let activeBoxId = "";
            
            // Wedge Drop: æ˜¨å¤©è¿˜åœ¨ 20 ä¸Šï¼Œä»Šå¤©æ”¶ç›˜ç ´ 20
            if (prevClose >= prevEma20 && curClose < curEma20) {
                activeBoxId = "box-wedgedrop";
            }
            // Wedge Pop: æ˜¨å¤©åœ¨ 20 ä¸‹ï¼Œä»Šå¤©æ”¶ç›˜ç«™ä¸Š 20
            else if (prevClose < prevEma20 && curClose > curEma20) {
                activeBoxId = "box-wedgepop";
            }
            // Uptrend: æŒç»­åœ¨ 20 ä¸Š
            else if (curClose >= curEma20) {
                activeBoxId = "box-uptrend";
            }
            // Downtrend: æŒç»­åœ¨ 20 ä¸‹
            else {
                activeBoxId = "box-downtrend";
            }
            
            document.getElementById(activeBoxId).classList.add('active');

            // =================================================================
            // 4. é‡åŒ–ç»†èŠ‚åˆ¤å®š (Quant Logic) - PDF Page 9, 13, 14
            // =================================================================
            
            // --- Downtrend åˆ¤å®š ---
            const isAir = curClose < curEma10; // Price < 10 EMA
            const isRevBar = curClose > curOpen; // Close > Open
            const volRatio = (curVol / avgVol).toFixed(1);
            
            document.getElementById('q-air').innerHTML = isAir 
                ? '<span class="badge badge-yes">YES</span>' 
                : '<span class="badge badge-no">NO</span>';
            document.getElementById('q-revbar').innerHTML = isRevBar 
                ? '<span class="badge badge-yes">YES</span>' 
                : '<span class="badge badge-no">NO</span>';
            document.getElementById('q-vol').innerHTML = curVol > avgVol 
                ? `<span class="badge badge-yes">YES (${volRatio}x)</span>` 
                : `<span class="badge badge-no">NO (${volRatio}x)</span>`;

            // --- Uptrend åˆ¤å®š ---
            
            // Check 1: Crossback (å›è¸©)
            // é€»è¾‘: æœ€ä½ä»·è§¦ç¢°äº† 10 æˆ– 20 EMA (Low <= EMAs)
            // æ³¨æ„: åªæœ‰åœ¨ Uptrend æ¡†é‡Œè¿™ä¸ªæ‰æ˜¾ç¤ºä¸ºæœ‰æ•ˆï¼Œä½†æˆ‘ä»¬æ€»æ˜¯è®¡ç®—å®ƒ
            const isCross10 = curLow <= curEma10;
            const isCross20 = curLow <= curEma20;
            const isCrossback = isCross10 || isCross20;
            
            let crossHtml = isCrossback 
                ? '<span class="badge badge-yes">YES (è§¦ç¢°)</span>' 
                : '<span class="badge badge-no">NO</span>';
            document.getElementById('q-cross').innerHTML = crossHtml;

            // Check 2: Breakout (å¹³å°çªç ´)
            // é€»è¾‘: æ”¶ç›˜ä»· > è¿‡å» 20 å¤©(ä¸å«ä»Šå¤©)çš„æœ€é«˜æ”¶ç›˜ä»·
            const past20Closes = closePrices.slice(lastIdx - 20, lastIdx);
            const periodHigh = Math.max(...past20Closes);
            const isBreakout = curClose > periodHigh;
            
            let breakHtml = isBreakout 
                ? '<span class="badge badge-yes">YES (æ–°é«˜)</span>' 
                : `<span class="badge badge-no">NO (<${periodHigh.toFixed(1)})</span>`;
            document.getElementById('q-break').innerHTML = breakHtml;

            // Check 3: Extension (å»¶ä¼¸ç‡)
            const extPct = ((curClose - curEma10) / curEma10) * 100;
            let extClass = "badge-yes";
            let extText = "HEALTHY";
            if (extPct > 20) { extClass = "badge-stop"; extText = "DANGER"; }
            else if (extPct > 10) { extClass = "badge-manual"; extText = "EXTENDED"; }
            
            document.getElementById('q-ext').innerHTML = `<span class="badge ${extClass}">${extText} (${extPct.toFixed(1)}%)</span>`;


            // =================================================================
            // 5. æ•°æ®æ¸²æŸ“
            // =================================================================
            resultArea.style.display = 'block';
            
            document.getElementById('val-price').textContent = "$" + curClose.toFixed(2);
            document.getElementById('val-ema10').textContent = "$" + curEma10.toFixed(2);
            document.getElementById('val-ema20').textContent = "$" + curEma20.toFixed(2);
            document.getElementById('val-ext').textContent = extPct.toFixed(2) + "%";

            // ä»·æ ¼é¢œè‰²è­¦å‘Šï¼šå¦‚æœæ”¶ç›˜ç ´ 20 EMAï¼Œæ˜¾ç¤ºçº¢è‰²
            if (curClose < curEma20) {
                document.getElementById('val-price').style.color = "#e53e3e";
            } else {
                document.getElementById('val-price').style.color = "#2d3748";
            }

        } catch (err) {
            console.error(err);
            errorDiv.innerHTML = `<strong>âš ï¸ è¿è¡Œå‡ºé”™:</strong> ${err.message}`;
            errorDiv.style.display = 'block';
        } finally {
            btn.disabled = false;
            btn.textContent = "æ‰§è¡Œé‡åŒ–åˆ†æ";
        }
    }
</script>

</body>
</html>
