<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oliver Kell Strategy Analyzer (Pro Version)</title>
    <style>
        /* =========================================
           1. å…¨å±€æ ·å¼ä¸å˜é‡å®šä¹‰
           ========================================= */
        :root {
            --primary-blue: #3182ce;
            --primary-dark: #2c5282;
            --accent-yellow: #d69e2e;
            --accent-purple: #805ad5;
            --danger-red: #e53e3e;
            --success-green: #38a169;
            --bg-color: #f7f9fc;
            --card-bg: #ffffff;
            --text-main: #2d3748;
            --text-sub: #718096;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 40px 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 950px;
            margin: 0 auto;
        }

        /* =========================================
           2. é¡¶éƒ¨å¡ç‰‡ä¸è¾“å…¥åŒº
           ========================================= */
        .main-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 40px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 30px;
        }

        h1 {
            margin-top: 0;
            color: var(--text-main);
            font-size: 28px;
            letter-spacing: -0.5px;
            border-bottom: 2px solid #edf2f7;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .subtitle-box {
            background-color: #ebf8ff;
            border-left: 5px solid var(--primary-blue);
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 30px;
        }

        .subtitle-box p {
            margin: 0;
            font-size: 14px;
            color: var(--primary-dark);
        }

        .input-section {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }

        input[type="text"] {
            flex: 1;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 18px;
            outline: none;
            transition: all 0.2s;
        }

        input[type="text"]:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }

        .analyze-btn {
            padding: 0 35px;
            background-color: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.1s, background-color 0.2s;
        }

        .analyze-btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-1px);
        }

        .analyze-btn:disabled {
            background-color: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        #error-message {
            color: var(--danger-red);
            font-size: 14px;
            margin-top: 10px;
            display: none;
            background: #fff5f5;
            padding: 10px;
            border-radius: 6px;
        }

        /* =========================================
           3. å‘¨æœŸçŠ¶æ€æ–¹æ¡† (Cycle Boxes)
           ========================================= */
        .cycle-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .cycle-box {
            background: #edf2f7;
            border-radius: 12px;
            padding: 20px;
            border: 3px solid transparent;
            opacity: 0.5;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            min-height: 200px; /* ç¡®ä¿æœ‰è¶³å¤Ÿé«˜åº¦ */
            display: flex;
            flex-direction: column;
        }

        /* æ¿€æ´»çŠ¶æ€ */
        .cycle-box.active {
            opacity: 1;
            background-color: #fff;
            border-color: var(--primary-blue);
            box-shadow: var(--shadow-md);
            transform: translateY(-5px);
            z-index: 10;
        }

        .cycle-box.bearish.active {
            border-color: var(--danger-red);
        }

        .cycle-box h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: var(--text-main);
        }

        .cycle-box .status-desc {
            font-size: 13px;
            color: var(--text-sub);
            margin-bottom: auto;
        }

        .book-ref {
            font-size: 11px;
            color: #a0aec0;
            font-style: italic;
            margin-top: 15px;
            border-top: 1px solid #e2e8f0;
            padding-top: 8px;
        }

        /* è¯¦æƒ…æŒ‰é’® */
        .show-detail-btn {
            background: none;
            border: none;
            color: var(--primary-blue);
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            text-align: left;
            padding: 0;
            text-decoration: underline;
        }

        /* =========================================
           4. è¯¦æƒ…å±•å¼€å¡ç‰‡ (Detail Cards)
           ========================================= */
        .detail-section {
            grid-column: 1 / -1;
            display: none;
            animation: slideDown 0.4s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .detail-card-inner {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-left: 5px solid var(--primary-blue);
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
        }

        .strategy-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .strategy-item {
            padding-bottom: 20px;
            margin-bottom: 20px;
            border-bottom: 1px dashed #e2e8f0;
        }

        .strategy-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 0;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .item-title {
            font-weight: 700;
            font-size: 15px;
            color: var(--text-main);
        }

        .item-desc {
            font-size: 13px;
            color: #4a5568;
            margin-bottom: 5px;
        }

        /* æ ‡ç­¾ Badge */
        .badge {
            font-size: 10px;
            text-transform: uppercase;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 800;
            letter-spacing: 0.5px;
        }
        .badge-stop { background-color: #fff5f5; color: var(--danger-red); border: 1px solid #fed7d7; }
        .badge-action { background-color: #f0fff4; color: var(--success-green); border: 1px solid #c6f6d5; }
        .badge-manual { background-color: #fffaf0; color: #b7791f; border: 1px solid #fbd38d; }

        .book-quote-box {
            background-color: #f7fafc;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 12px;
            color: #718096;
            font-style: italic;
            margin-top: 8px;
            border-left: 3px solid #cbd5e0;
        }

        /* =========================================
           5. æ•°æ®ä»ªè¡¨ç›˜ (Metrics)
           ========================================= */
        .metrics-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 20px;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px dashed #e2e8f0;
        }

        .metric-card {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #e2e8f0;
            box-shadow: var(--shadow-sm);
        }

        .metric-title {
            font-size: 12px;
            text-transform: uppercase;
            color: #a0aec0;
            letter-spacing: 1px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 800;
            color: var(--text-main);
            font-family: "SF Mono", "Menlo", monospace; /* å¼ºè°ƒæ•°å­—æ„Ÿ */
        }

        /* é’ˆå¯¹ 10/20 EMA çš„ç‰¹æ®Šé¢œè‰² */
        .val-ema10 { color: var(--accent-yellow); }
        .val-ema20 { color: var(--accent-purple); }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .cycle-grid { grid-template-columns: 1fr 1fr; }
            .container { padding: 20px 10px; }
            .main-card { padding: 20px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="main-card">
        <h1>ğŸ“Š Oliver Kell ç­–ç•¥åˆ†æå™¨ <span style="font-size:14px; color:#aaa; font-weight:normal;">(Pro Edition)</span></h1>
        
        <div class="subtitle-box">
            <p><strong>âš ï¸ æ­¢æŸé“å¾‹ï¼š</strong>æ‰€æœ‰å‡çº¿æ­¢æŸ (Stop Loss) å‡ä»¥æ¯æ—¥ <strong>æ”¶ç›˜ä»· (Closing Price)</strong> ä¸ºå‡†ã€‚ç›˜ä¸­åˆºç ´ä¸ç®—ç ´ä½ (Undercut & Reclaim)ï¼Œè¯·å‹¿åœ¨ç›˜ä¸­ææ…Œå–å‡ºã€‚</p>
        </div>

        <div class="input-section">
            <input type="text" id="symbol" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç  (ä¾‹å¦‚: ERJ, TSLA, NVDA)" value="ERJ">
            <button id="analyze-btn" class="analyze-btn" onclick="runAnalysis()">å¼€å§‹æ·±åº¦åˆ†æ</button>
        </div>
        <div id="error-message"></div>

        <div id="result-area" style="display:none;">
            
            <div class="cycle-grid">
                
                <div id="box-downtrend" class="cycle-box bearish">
                    <h3>1. ä¸‹è·Œ/ç­‘åº•</h3>
                    <div class="status-desc">
                        <p>Price < 20 EMA</p>
                        <p>ç­‰å¾…åè½¬ä¿¡å· (Reversal Extension)</p>
                    </div>
                    <span class="book-ref">Page 9: Process Step T</span>
                    <button class="show-detail-btn" onclick="toggleDetail('detail-downtrend')">æŸ¥çœ‹ç­‘åº•æ ‡å‡† â–¼</button>
                </div>

                <div id="box-wedgepop" class="cycle-box">
                    <h3>2. æ¥”å½¢çªç ´</h3>
                    <div class="status-desc">
                        <p><strong>æ”¶ç›˜ä»·</strong> æ”¶å¤ 10/20 EMA</p>
                        <p>ç¡®è®¤åè½¬æœ‰æ•ˆ</p>
                    </div>
                    <span class="book-ref">Page 10: Wedge Pop</span>
                    <button class="show-detail-btn" onclick="toggleDetail('detail-wedgepop')">æŸ¥çœ‹åˆå§‹æ­¢æŸ â–¼</button>
                </div>

                <div id="box-uptrend" class="cycle-box">
                    <h3>3. ä¸Šå‡è¶‹åŠ¿</h3>
                    <div class="status-desc">
                        <p>æ”¶ç›˜ä»· > 20 EMA</p>
                        <p>éª‘ä¹˜å‡çº¿ (Ride the MAs)</p>
                    </div>
                    <span class="book-ref">Page 14: Step T Continued</span>
                    <button class="show-detail-btn" onclick="toggleDetail('detail-uptrend')">æŸ¥çœ‹åŠ ä»“/æ­¢ç›ˆ â–¼</button>
                </div>

                <div id="box-wedgedrop" class="cycle-box bearish">
                    <h3>4. è¶‹åŠ¿ç»ˆç»“</h3>
                    <div class="status-desc">
                        <p style="color:var(--danger-red); font-weight:bold;">âš ï¸ ç¦»åœºè­¦æŠ¥</p>
                        <p><strong>æ”¶ç›˜ä»·è·Œç ´</strong> 20 EMA</p>
                    </div>
                    <span class="book-ref">Page 12: Wedge Drop</span>
                    <button class="show-detail-btn" onclick="toggleDetail('detail-wedgedrop')">æŸ¥çœ‹å–å‡ºå‡†åˆ™ â–¼</button>
                </div>

                <div id="detail-downtrend" class="detail-section">
                    <div class="detail-card-inner">
                        <ul class="strategy-list">
                            <li class="strategy-item">
                                <div class="item-header">
                                    <span class="item-title">A. å¤§å‘¨æœŸæ”¯æ’‘ (Higher Timeframe)</span>
                                    <span class="badge badge-manual">éœ€äººå·¥ç¡®è®¤</span>
                                </div>
                                <div class="item-desc">ä»£ç åªèƒ½åˆ†ææ—¥çº¿ã€‚è¯·äººå·¥æ£€æŸ¥å‘¨çº¿ (Weekly) æˆ–æœˆçº¿ (Monthly) æ˜¯å¦åˆ°è¾¾å…³é”®æ”¯æ’‘ä½ã€‚</div>
                                <div class="book-quote-box">"Look for a defined support level on a higher timeframe." (Page 9)</div>
                            </li>
                            <li class="strategy-item">
                                <div class="item-header">
                                    <span class="item-title">B. å‡çº¿ç©ºé—´ (Air)</span>
                                    <span id="check-air" class="badge">--</span>
                                </div>
                                <div class="item-desc">ä»·æ ¼å¿…é¡»åœ¨ 10 EMA ä¸‹æ–¹ (Price &lt; 10 EMA)ï¼Œä¸”æœ‰è¶³å¤Ÿç©ºé—´ã€‚</div>
                            </li>
                            <li class="strategy-item">
                                <div class="item-header">
                                    <span class="item-title">C/D. åè½¬ K çº¿ä¸æ”¾é‡</span>
                                    <span id="check-rev" class="badge">--</span>
                                </div>
                                <div class="item-desc">éœ€è¦é˜³çº¿ (Close > Open) å¹¶ä¸”æˆäº¤é‡æ”¾å¤§ (Capitulation)ã€‚</div>
                            </li>
                        </ul>
                    </div>
                </div>

                <div id="detail-wedgepop" class="detail-section">
                    <div class="detail-card-inner">
                        <p style="font-size:14px; font-weight:bold; margin-bottom:15px;">åˆå§‹æ­¢æŸ (Initial Stop) çš„ä¸¤ä¸ªé€‰æ‹©ï¼š</p>
                        <ul class="strategy-list">
                            <li class="strategy-item">
                                <div class="item-header">
                                    <span class="item-title">é€‰æ‹© 1: è¿‘æœŸç›˜æ•´åŒºä½ç‚¹</span>
                                    <span class="badge badge-stop">STOP (CLOSE)</span>
                                </div>
                                <div class="item-desc">é€‚ç”¨äºçªç ´å‰æœ‰æ•°æ—¥æ¨ªç›˜çš„æƒ…å†µã€‚ä»¥æ”¶ç›˜è·Œç ´ç›˜æ•´åŒºä¸‹æ²¿ä¸ºæ­¢æŸã€‚</div>
                                <div class="book-quote-box">"Stop below the near-term price consolidation." (Page 10)</div>
                            </li>
                            <li class="strategy-item">
                                <div class="item-header">
                                    <span class="item-title">é€‰æ‹© 2: çªç ´æ—¥ä½ç‚¹</span>
                                    <span class="badge badge-stop">STOP (CLOSE)</span>
                                </div>
                                <div class="item-desc">é€‚ç”¨äºçˆ†å‘æ€§å•æ—¥çªç ´ã€‚ä»¥æ”¶ç›˜è·Œç ´çªç ´æ—¥å½“å¤©çš„æœ€ä½ä»·ä¸ºæ­¢æŸã€‚</div>
                                <div class="book-quote-box">"Stops raised to below the breakout dayâ€™s low." (Page 58)</div>
                            </li>
                        </ul>
                    </div>
                </div>

                <div id="detail-uptrend" class="detail-section">
                    <div class="detail-card-inner">
                        <ul class="strategy-list">
                            <li class="strategy-item">
                                <div class="item-header">
                                    <span class="item-title">å‡çº¿å›è¸© (EMA Crossback)</span>
                                    <span class="badge badge-action">ADD / BUY</span>
                                </div>
                                <div class="item-desc">å½“ä»·æ ¼å›è°ƒè§¦ç¢° 10/20 EMA æ—¶ä¹°å…¥ã€‚</div>
                                <div class="item-desc" style="color:#e53e3e; margin-top:5px;"><strong>æ­¢æŸï¼š</strong>æ”¶ç›˜ä»·è·Œç ´ (Close Below) 10/20 EMAã€‚</div>
                                <div class="book-quote-box">"Buy against the 10/20 EMA... stops at a loss of the averages." (Page 13)</div>
                            </li>
                            <li class="strategy-item">
                                <div class="item-header">
                                    <span class="item-title">åº•å‡çªç ´ (Base n' Break)</span>
                                    <span class="badge badge-action">ADD</span>
                                </div>
                                <div class="item-desc">å½“ä»·æ ¼çªç ´ç›˜æ•´å¹³å°åˆ› 20 æ—¥æ–°é«˜æ—¶åŠ ä»“ã€‚</div>
                                <div class="item-desc" style="color:#e53e3e; margin-top:5px;"><strong>æ­¢æŸï¼š</strong>æ”¶ç›˜ä»·è·Œç ´å½¢æ€åº•éƒ¨ (Bottom of Base)ã€‚</div>
                            </li>
                            <li class="strategy-item">
                                <div class="item-header">
                                    <span class="item-title">åŠ›ç«­è­¦ç¤º (Exhaustion)</span>
                                    <span id="check-ext" class="badge">--</span>
                                </div>
                                <div class="item-desc">æ£€æŸ¥ä¹–ç¦»ç‡ã€‚2nd Extension æ˜¯æ­¢ç›ˆç‚¹ï¼Œ3rd Extension æ˜¯ç»ˆç‚¹ã€‚</div>
                            </li>
                        </ul>
                    </div>
                </div>

                <div id="detail-wedgedrop" class="detail-section">
                    <div class="detail-card-inner">
                        <ul class="strategy-list">
                            <li class="strategy-item">
                                <div class="item-header">
                                    <span class="item-title">äººå·¥åˆ¤æ–­ (Judgement Call)</span>
                                    <span class="badge badge-manual">é‡è¦</span>
                                </div>
                                <div class="item-desc">è¯·è§‚å¯Ÿ K çº¿å›¾å†å²ï¼šè¿™åªè‚¡ç¥¨æ˜¯å°Šé‡ 10 EMA è¿˜æ˜¯ 20 EMAï¼Ÿ</div>
                                <ul style="font-size:13px; margin-top:10px; color:#4a5568;">
                                    <li>å¦‚æœæ˜¯è¶…çº§å¼ºåŠ¿è‚¡ (å°Šé‡ 10 EMA) â” <strong>æ”¶ç›˜ç ´ 10 EMA å¿…é¡»å‡ä»“/ç¦»åœºã€‚</strong></li>
                                    <li>å¦‚æœæ˜¯ç¨³å¥è¶‹åŠ¿è‚¡ (å°Šé‡ 20 EMA) â” <strong>æ”¶ç›˜ç ´ 20 EMA æ˜¯æœ€åç¦»åœºç‚¹ã€‚</strong></li>
                                </ul>
                                <div class="book-quote-box">"Determining which MA a stock is respecting is a judgement call." (Page 23)</div>
                            </li>
                        </ul>
                    </div>
                </div>

            </div> <div class="metrics-container">
                <div class="metric-card">
                    <div class="metric-title">å½“å‰æ”¶ç›˜ä»·</div>
                    <div class="metric-value" id="val-price">--</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">10 EMA (çŸ­æœŸ)</div>
                    <div class="metric-value val-ema10" id="val-ema10">--</div>
                </div>
                <div class="metric-card" style="border-bottom: 4px solid var(--primary-blue);">
                    <div class="metric-title">20 EMA (ç”Ÿæ­»çº¿)</div>
                    <div class="metric-value val-ema20" id="val-ema20">--</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">10æ—¥å»¶ä¼¸ç‡ (Extension)</div>
                    <div class="metric-value" id="val-ext">--</div>
                </div>
            </div>

        </div> </div>
</div>

<script>
    // åˆ‡æ¢è¯¦æƒ…å¡ç‰‡æ˜¾ç¤º
    function toggleDetail(id) {
        const el = document.getElementById(id);
        const all = document.querySelectorAll('.detail-section');
        
        // å¦‚æœå½“å‰æ˜¯æ‰“å¼€çš„ï¼Œå°±å…³é—­
        if (el.style.display === 'block') {
            el.style.display = 'none';
        } else {
            // å¦åˆ™å…³é—­å…¶ä»–æ‰€æœ‰ï¼Œæ‰“å¼€å½“å‰
            all.forEach(d => d.style.display = 'none');
            el.style.display = 'block';
        }
    }

    // è®¡ç®— EMA å‡½æ•°
    function calculateEMA(prices, period) {
        if (prices.length < period) return [];
        const k = 2 / (period + 1);
        // ç¬¬ä¸€å¤©ä½¿ç”¨ç®€å•å¹³å‡ (SMA) ä½œä¸ºåˆå§‹å€¼
        let emaArray = [prices.slice(0, period).reduce((a,b)=>a+b,0)/period];
        // åç»­ä½¿ç”¨ EMA å…¬å¼
        for(let i = period; i < prices.length; i++) {
            const val = prices[i] * k + emaArray[emaArray.length - 1] * (1 - k);
            emaArray.push(val);
        }
        // ä¸ºäº†æ–¹ä¾¿å¯¹é½æ•°ç»„ä¸‹æ ‡ï¼Œå‰é¢å¡«å…… null (å¯é€‰ï¼Œè¿™é‡Œæˆ‘ä»¬åªå–æœ€åå‡ ä¸ªå€¼)
        // è¿™é‡Œè¿”å›çš„æ•°ç»„é•¿åº¦ = prices.length - period + 1
        return emaArray;
    }

    // ä¸»åˆ†æå‡½æ•°
    async function runAnalysis() {
        const symbol = document.getElementById('symbol').value.trim().toUpperCase();
        const btn = document.getElementById('analyze-btn');
        const errorDiv = document.getElementById('error-message');
        const resultArea = document.getElementById('result-area');

        if(!symbol) {
            alert("è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ");
            return;
        }

        // é‡ç½®çŠ¶æ€
        btn.disabled = true;
        btn.textContent = "æ­£åœ¨åˆ†ææ•°æ®...";
        errorDiv.style.display = 'none';
        resultArea.style.display = 'none';
        document.querySelectorAll('.cycle-box').forEach(el => el.classList.remove('active', 'bearish'));
        document.getElementById('box-downtrend').classList.add('bearish'); // æ¢å¤é»˜è®¤é¢œè‰²ç±»
        document.getElementById('box-wedgedrop').classList.add('bearish');

        try {
            // =================================================================
            // âš ï¸ æ•°æ®æºæ¥å…¥ç‚¹ (API Integration Point)
            // =================================================================
            // é€‰é¡¹ A: çœŸå®ç¯å¢ƒ (å¦‚æœä½ æœ‰ Vercel API æˆ–åç«¯)
            // const response = await fetch(`/api/stock?symbol=${symbol}`);
            
            // é€‰é¡¹ B: AlphaVantage (éœ€è¦å¡«å…¥ä½ çš„ Key)
            // const apiKey = "YOUR_API_KEY";
            // const response = await fetch(`https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${symbol}&apikey=${apiKey}`);
            
            // é€‰é¡¹ C: æ¨¡æ‹Ÿæ•°æ® (ç”¨äºæ¼”ç¤º ERJ æƒ…å†µ)
            // è¿™é‡Œæˆ‘å†™äº†ä¸€ä¸ªæ¨¡æ‹Ÿå™¨ï¼Œæ¨¡æ‹Ÿä½ æåˆ°çš„ ERJ æ•°æ®ç»“æ„ï¼Œä»¥ä¾¿ä½ èƒ½ç›´æ¥çœ‹åˆ°æ•ˆæœ
            // å®é™…ä½¿ç”¨æ—¶ï¼Œè¯·åˆ é™¤è¿™éƒ¨åˆ†ï¼Œä½¿ç”¨ä¸Šé¢çš„ fetch
            const mockResponse = await mockFetchERJ(symbol); 
            const data = mockResponse; // å¦‚æœç”¨ fetchï¼Œè¿™é‡Œæ˜¯ await response.json()

            if (!data["Time Series (Daily)"]) {
                throw new Error("APIè¿”å›æ•°æ®å¼‚å¸¸æˆ–æ¬¡æ•°å—é™");
            }

            const timeSeries = data["Time Series (Daily)"];
            const dates = Object.keys(timeSeries).sort(); // å‡åºæ’åˆ—æ—¥æœŸ

            // æå–æ•°æ®æ•°ç»„
            const closePrices = dates.map(d => parseFloat(timeSeries[d]["4. close"]));
            const openPrices = dates.map(d => parseFloat(timeSeries[d]["1. open"]));
            const volumes = dates.map(d => parseFloat(timeSeries[d]["5. volume"]));

            if(closePrices.length < 30) throw new Error("å†å²æ•°æ®ä¸è¶³ï¼Œæ— æ³•è®¡ç®—å‡çº¿");

            // è®¡ç®—å‡çº¿
            const ema10Array = calculateEMA(closePrices, 10);
            const ema20Array = calculateEMA(closePrices, 20);

            // è·å–æœ€æ–°æ•°æ®ç‚¹ (Last Index)
            // æ³¨æ„: calculateEMA è¿”å›æ•°ç»„æ¯”åŸæ•°ç»„çŸ­ (period-1)ï¼Œæ‰€ä»¥è¦å°å¿ƒç´¢å¼•
            // ç®€å•èµ·è§ï¼Œæˆ‘ä»¬å–å„è‡ªæ•°ç»„çš„æœ€åä¸€ä¸ªå…ƒç´ ä½œä¸ºâ€œå½“å‰å€¼â€
            
            const curClose = closePrices[closePrices.length - 1];
            const prevClose = closePrices[closePrices.length - 2];
            
            const curOpen = openPrices[openPrices.length - 1];
            const curVol = volumes[volumes.length - 1];
            
            // è®¡ç®— 20æ—¥å¹³å‡æˆäº¤é‡
            const avgVol = volumes.slice(-21, -1).reduce((a,b)=>a+b,0) / 20;

            const curEma10 = ema10Array[ema10Array.length - 1];
            const curEma20 = ema20Array[ema20Array.length - 1];
            const prevEma20 = ema20Array[ema20Array.length - 2];

            // =================================================================
            // ğŸ§  æ ¸å¿ƒé€»è¾‘åˆ¤å®š (Kell Logic)
            // =================================================================
            
            // 1. åˆ¤å®šå¤„äºå“ªä¸ªæ–¹æ¡† (Cycle Box)
            let activeBoxId = "";
            
            // Wedge Drop: æ˜¨å¤©è¿˜åœ¨20çº¿ä¸Šï¼Œä»Šå¤©æ”¶ç›˜ç ´20çº¿
            if (prevClose >= prevEma20 && curClose < curEma20) {
                activeBoxId = "box-wedgedrop";
            }
            // Wedge Pop: æ˜¨å¤©åœ¨20çº¿ä¸‹ï¼Œä»Šå¤©æ”¶ç›˜ç«™ä¸Š20çº¿
            else if (prevClose < prevEma20 && curClose > curEma20) {
                activeBoxId = "box-wedgepop";
            }
            // Uptrend: æŒç»­åœ¨20çº¿ä¸Š
            else if (curClose >= curEma20) {
                activeBoxId = "box-uptrend";
            }
            // Downtrend: æŒç»­åœ¨20çº¿ä¸‹
            else {
                activeBoxId = "box-downtrend";
            }
            
            document.getElementById(activeBoxId).classList.add('active');

            // 2. è¯¦æƒ…é€»è¾‘è®¡ç®—
            // 2.1 Downtrend Checks
            const isAir = curClose < curEma10;
            const isRevBar = curClose > curOpen; // é˜³çº¿
            const isCapitulation = curVol > avgVol; // æ”¾é‡

            document.getElementById('check-air').innerHTML = isAir 
                ? '<span class="badge badge-action">YES (Air)</span>' 
                : '<span class="badge">NO</span>';
            
            document.getElementById('check-rev').innerHTML = (isRevBar && isCapitulation) 
                ? '<span class="badge badge-action">YES (Combo)</span>' 
                : '<span class="badge">Wait</span>';

            // 2.2 Uptrend Checks (Extension)
            const extPct = ((curClose - curEma10) / curEma10) * 100;
            let extHtml = "";
            if(extPct > 20) extHtml = `<span class="badge badge-stop" style="background:#fed7d7">DANGER (${extPct.toFixed(1)}%)</span>`;
            else if(extPct > 10) extHtml = `<span class="badge" style="background:#feebc8; color:#744210">Extended (${extPct.toFixed(1)}%)</span>`;
            else extHtml = `<span class="badge badge-action">Healthy (${extPct.toFixed(1)}%)</span>`;
            
            document.getElementById('check-ext').innerHTML = extHtml;


            // =================================================================
            // ğŸ¨ æ•°æ®æ¸²æŸ“
            // =================================================================
            resultArea.style.display = 'block';
            
            document.getElementById('val-price').textContent = "$" + curClose.toFixed(2);
            document.getElementById('val-ema10').textContent = "$" + curEma10.toFixed(2);
            document.getElementById('val-ema20').textContent = "$" + curEma20.toFixed(2);
            document.getElementById('val-ext').textContent = extPct.toFixed(2) + "%";

            // é¢œè‰²é«˜äº®ï¼šå¦‚æœæ˜¯è·Œç ´çŠ¶æ€ï¼Œä»·æ ¼æ˜¾ç¤ºçº¢è‰²
            if (curClose < curEma20) {
                document.getElementById('val-price').style.color = "#e53e3e";
            } else {
                document.getElementById('val-price').style.color = "#2d3748";
            }


        } catch (err) {
            console.error(err);
            errorDiv.textContent = "åˆ†æå¤±è´¥: " + err.message;
            errorDiv.style.display = 'block';
        } finally {
            btn.disabled = false;
            btn.textContent = "å¼€å§‹æ·±åº¦åˆ†æ";
        }
    }

    // --- æ¨¡æ‹Ÿæ•°æ®å‡½æ•° (ä»…ç”¨äºæ¼”ç¤ºï¼Œå®é™…ä½¿ç”¨è¯·åˆ é™¤) ---
    async function mockFetchERJ(symbol) {
        // è¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿå»¶è¿Ÿçš„ Promise
        await new Promise(r => setTimeout(r, 800));
        
        // æ„é€  60 å¤©çš„æ•°æ®ï¼Œæ¨¡æ‹Ÿ ERJ ç°åœ¨çš„èµ°åŠ¿ (Price 73.45, EMA10~74.6, EMA20~73.35)
        // æˆ‘ä»¬å€’æ¨ç”Ÿæˆæ•°æ®
        let dates = [];
        let dataObj = {};
        let price = 60; 
        
        for(let i=0; i<60; i++) {
            let date = new Date();
            date.setDate(date.getDate() - (60-i));
            let dateStr = date.toISOString().split('T')[0];
            
            // ç®€å•æ¨¡æ‹Ÿä¸€ä¸ªä¸Šå‡è¶‹åŠ¿
            if(i < 50) price += 0.5; // ç¨³æ­¥ä¸Šæ¶¨
            else price -= 0.2; // æœ€è¿‘å‡ å¤©å›è°ƒ
            
            // æ‰‹åŠ¨ä¿®æ­£æœ€åä¸€å¤©çš„æ•°æ®ä»¥åŒ¹é…ä½ çš„çœŸå®æ•°æ®
            if(i === 59) price = 73.45; 

            dataObj[dateStr] = {
                "1. open": (price - 0.5).toFixed(2),
                "4. close": price.toFixed(2),
                "5. volume": "1000000"
            };
        }
        return { "Time Series (Daily)": dataObj };
    }
</script>

</body>
</html>
